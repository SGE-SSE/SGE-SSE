<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SAI GANESH ELECTRICALS - SSE</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin:20px; }
    h1 { font-size:22px; margin-bottom:4px; }
    h2 { font-size:16px; margin-top:0; font-weight:normal; color:#444; }
    .searchbox { margin:15px 0; }
    #search { width:100%; padding:8px; font-size:16px; }
    #dropdown { border:1px solid #ccc; display:none; max-height:200px; overflow-y:auto; position:absolute; background:#fff; width:90%; z-index:10; }
    .opt { padding:6px; cursor:pointer; }
    .opt:hover { background:#eee; }
    .mark { background:yellow; }
    .si { margin:5px 0; padding:6px; background:#f8f8f8; border:1px solid #ddd; display:flex; justify-content:space-between; align-items:center; }
    .rm { margin-left:10px; background:red; color:#fff; border:none; cursor:pointer; padding:3px 8px; }
    .btn-wa { background:#25D366; color:#fff; padding:8px 12px; border:none; cursor:pointer; }
    .btn-email { background:#007BFF; color:#fff; padding:8px 12px; border:none; cursor:pointer; margin-left:10px; }
    #statusMsg { margin-top:15px; font-weight:bold; }
    .success { color:green; }
    .error { color:red; }
  </style>
</head>
<body>

  <!-- Header -->
  <h1>SAI GANESH ELECTRICALS - SSE</h1>
  <h2>
    PROP: DASARI KRISHNA<br>
    Phone: 9885750057 | Email: krishnadsge@gmail.com<br>
    Sales Executive: VINODHARSHA | Email: vinodharsha21@gmail.com | WhatsApp: 7483362854<br>
    <em>We may be stationary, but our reach is dynamic!</em>
  </h2>

  <!-- Search -->
  <div class="searchbox">
    <input id="search" type="text" placeholder="Search items (e.g. 1sqmm, 4sqmm)...">
    <div id="dropdown"></div>
  </div>

  <!-- Selected Items -->
  <h3>Selected Items</h3>
  <div id="selectedList"></div>

  <!-- Customer Form -->
  <h3>Customer Details</h3>
  <form id="custForm">
    <label for="custName">Your Name *</label><br>
    <input id="custName" name="name" type="text" required><br><br>

    <label for="custPhone">Phone *</label><br>
    <input id="custPhone" name="phone" type="text" required><br><br>

    <label for="custEmail">Email</label><br>
    <input id="custEmail" name="email" type="email"><br><br>

    <label for="custMsg">Message</label><br>
    <textarea id="custMsg" name="message"></textarea><br><br>

    <input type="hidden" name="selected_items" id="selected_items_field">

    <button type="button" class="btn-wa" onclick="sendWhatsApp()">Send via WhatsApp</button>
    <button type="button" class="btn-email" onclick="sendEmail()">Send via Email</button>
  </form>

  <!-- Status Message -->
  <div id="statusMsg"></div>

  <script>
    // --------------------------
    // Config
    // --------------------------
    const EXCEL_FILE = 'cc.xlsx';
    const WHATSAPP_NUMBER_IN = '917483362854';
    const FORMSPREE_URL = 'https://formspree.io/f/xnnzygoz';

    // --------------------------
    // Helpers
    // --------------------------
    const $ = id => document.getElementById(id);
    function normalize(s){
      return String(s).toLowerCase().replace(/[\s.\-_/]+/g,'');
    }
    function highlightMatch(original, qNorm){
      const plain = String(original);
      const compact = normalize(plain);
      const idx = compact.indexOf(qNorm);
      if(idx < 0) return plain;

      const map = [];
      for(let i=0,c=0;i<plain.length;i++){
        const ch = plain[i];
        if(!/[\s.\-_/]/.test(ch)){ map[c++] = i; }
      }
      const s = map[idx] ?? 0;
      const e = (map[idx + qNorm.length - 1] ?? (plain.length-1)) + 1;
      return plain.slice(0,s) + '<span class="mark">' + plain.slice(s,e) + '</span>' + plain.slice(e);
    }

    // --------------------------
    // Data
    // --------------------------
    let ALL_ITEMS = [];
    let selected = [];

    async function loadExcelItems(){
      try{
        const res = await fetch(EXCEL_FILE, {cache:'no-store'});
        if(!res.ok) throw new Error('Cannot fetch cc.xlsx');
        const buf = await res.arrayBuffer();
        const wb = XLSX.read(buf, {type:'array'});
        const ws = wb.Sheets[wb.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(ws, {defval:''});

        const items = [];
        for(const r of rows){
          const val = (r['Item'] ?? '').toString().trim();
          if(val) items.push(val);
        }
        ALL_ITEMS = items;
      }catch(err){
        console.error('Excel load error:', err);
        ALL_ITEMS = ['Fallback Item A','Fallback Item B'];
      }
    }

    // --------------------------
    // UI Logic
    // --------------------------
    const search = $('search');
    const dropdown = $('dropdown');
    const selectedList = $('selectedList');
    const hiddenSelectedField = $('selected_items_field');
    const statusMsg = $('statusMsg');

    search.addEventListener('input', () => {
      const q = normalize(search.value);
      dropdown.innerHTML = '';
      if(!q){ dropdown.style.display='none'; return; }

      const results = ALL_ITEMS.filter(it => normalize(it).includes(q)).slice(0,300);
      if(results.length === 0){ dropdown.style.display='none'; return; }

      results.forEach(it=>{
        const div = document.createElement('div');
        div.className = 'opt';
        div.innerHTML = highlightMatch(it, q);
        div.onclick = ()=> addItem(it);
        dropdown.appendChild(div);
      });
      dropdown.style.display = 'block';
    });

    function addItem(item){
      selected.push(item);
      renderSelected();
      dropdown.style.display='none';
      search.value='';
      search.focus();
    }
    function removeItem(idx){
      selected.splice(idx,1);
      renderSelected();
    }
    function renderSelected(){
      selectedList.innerHTML = '';
      selected.forEach((it, i)=>{
        const row = document.createElement('div');
        row.className = 'si';
        row.innerHTML = `<span>${it}</span><button class="rm" onclick="removeItem(${i})">Remove</button>`;
        selectedList.appendChild(row);
      });
      hiddenSelectedField.value = selected.length ? `Selected items:\n• ${selected.join('\n• ')}` : '';
    }

    // --------------------------
    // Send actions
    // --------------------------
    function collectCustomer(){
      const name = $('custName').value.trim();
      const phone = $('custPhone').value.trim();
      const email = $('custEmail').value.trim();
      const msg = $('custMsg').value.trim();
      if(!name || !phone){
        showStatus("Please fill your Name and Phone.", "error");
        return null;
      }
      return {name, phone, email, msg};
    }

    function showStatus(text, type){
      statusMsg.textContent = text;
      statusMsg.className = type;
    }

    function sendWhatsApp(){
      const d = collectCustomer(); if(!d) return;
      const text =
`Customer Enquiry - Electrical Items

Items:
• ${selected.join('\n• ')}

Customer:
Name: ${d.name}
Phone: ${d.phone}
Email: ${d.email}
Message: ${d.msg}`;
      const url = 'https://wa.me/' + WHATSAPP_NUMBER_IN + '?text=' + encodeURIComponent(text);
      window.open(url, '_blank');
      showStatus("✅ WhatsApp window opened. Please send the message.", "success");
    }

    async function sendEmail(){
      renderSelected();
      const d = collectCustomer();
      if(!d) return;

      const formData = new FormData();
      formData.append("name", d.name);
      formData.append("phone", d.phone);
      formData.append("email", d.email);
      formData.append("message", d.msg);
      formData.append("selected_items", selected.length ? selected.join(", ") : "No items");

      try {
        const res = await fetch(FORMSPREE_URL, {
          method: "POST",
          body: formData,
          headers: { "Accept": "application/json" }
        });
        if(res.ok){
          showStatus("✅ Email enquiry sent successfully!", "success");
          $('custForm').reset();
          selected = [];
          renderSelected();
        } else {
          showStatus("❌ Failed to send email. Please try again.", "error");
        }
      } catch(err){
        showStatus("❌ Error: " + err.message, "error");
      }
    }

    window.removeItem = removeItem;
    window.sendWhatsApp = sendWhatsApp;
    window.sendEmail = sendEmail;
    loadExcelItems();
  </script>
</body>
</html>
