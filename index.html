<script>
  const EXCEL_FILE = 'cc.xlsx';
  const $ = id => document.getElementById(id);

  function normalize(s){
    return String(s).toLowerCase().replace(/[\s.\-_/]+/g,'');
  }
  function highlightMatch(original, qNorm){
    const plain = String(original);
    const compact = normalize(plain);
    const idx = compact.indexOf(qNorm);
    if(idx < 0) return plain;
    const map = [];
    for(let i=0,c=0;i<plain.length;i++){
      const ch = plain[i];
      if(!/[\s.\-_/]/.test(ch)){ map[c++] = i; }
    }
    const s = map[idx] ?? 0;
    const e = (map[idx + qNorm.length - 1] ?? (plain.length-1)) + 1;
    return plain.slice(0,s) + '<span class="mark">' + plain.slice(s,e) + '</span>' + plain.slice(e);
  }

  let ALL_ITEMS = [];
  let selected = [];

  async function loadExcelItems(){
    try{
      const res = await fetch(EXCEL_FILE, {cache:'no-store'});
      if(!res.ok) throw new Error('Cannot fetch cc.xlsx');
      const buf = await res.arrayBuffer();
      const wb = XLSX.read(buf, {type:'array'});
      const ws = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(ws, {defval:''});

      const items = [];
      for(const r of rows){
        // normalize keys
        const keys = Object.keys(r).reduce((acc,k)=>{
          acc[normalize(k)] = r[k];
          return acc;
        },{});

        const val = (keys['item'] ?? '').toString().trim();
        const unit = (keys['unit'] ?? keys['units'] ?? '').toString().trim();

        if(val){
          items.push({item: val, unit: unit || 'Nos'});
        }
      }
      ALL_ITEMS = items;
      console.log("Loaded items:", ALL_ITEMS.slice(0,5)); // debug
    }catch(err){
      console.error('Excel load error:', err);
      ALL_ITEMS = [{item:'Fallback Item A', unit:'Nos'},{item:'Fallback Item B', unit:'Mtrs'}];
    }
  }

  const search = $('search');
  const dropdown = $('dropdown');
  const selectedList = $('selectedList');
  const hiddenSelectedField = $('selected_items_field');

  search.addEventListener('input', () => {
    const q = normalize(search.value);
    dropdown.innerHTML = '';
    if(!q){ dropdown.style.display='none'; return; }

    const results = ALL_ITEMS.filter(it => normalize(it.item).includes(q)).slice(0,300);
    if(results.length === 0){ dropdown.style.display='none'; return; }

    results.forEach(it=>{
      const div = document.createElement('div');
      div.className = 'opt';
      div.innerHTML = highlightMatch(it.item, q);
      div.onclick = ()=> addItem(it);
      dropdown.appendChild(div);
    });
    dropdown.style.display = 'block';
  });

  function addItem(it){
    const qty = prompt(`Enter quantity for: ${it.item}`);
    if(!qty) return;
    selected.push({item: it.item, unit: it.unit, qty: qty});
    renderSelected();
    dropdown.style.display='none';
    search.value='';
    search.focus();
  }
  function removeItem(idx){
    selected.splice(idx,1);
    renderSelected();
  }
  function renderSelected(){
    selectedList.innerHTML = '';
    selected.forEach((it, i)=>{
      const row = document.createElement('div');
      row.className = 'si';
      row.innerHTML = `<span>${it.item} – ${it.qty} ${it.unit}</span>
        <button class="rm" onclick="removeItem(${i})">Remove</button>`;
      selectedList.appendChild(row);
    });
    hiddenSelectedField.value = selected.length ? `Selected items:\n• ${selected.map(it=>`${it.item} – ${it.qty} ${it.unit}`).join('\n• ')}` : '';
  }

  window.removeItem = removeItem;
  loadExcelItems();
</script> 
